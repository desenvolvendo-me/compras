<div class="tabs">
  <ul>
    <li><a href="#general">Principal</a></li>
    <li><a href="#partners">Sócios/Responsáveis pela empresa</a></li>
  </ul>

  <div id="general">
    <%= render 'general', :f => f %>
  </div>

  <div id="partners">
    <div id="msg-no-partners">
    </div>

    <%= render 'partners', :f => f %>
  </div>
</div>

<script>
  $('.tabs').tabs({
    create: function () {
      var tabWithError = $('.ui-tabs-panel:has(.error)', this).attr('id');

      if (tabWithError) {
        $(this).tabs('select', tabWithError);
      }
    }
  });

  $('#provider_property_id').change(function(event, data) {
    if (data) {
      var record = data.record;
      $('#provider_person').val(record.data('owner'));
      $('#provider_person_id').val(record.data('owner-id'));
    }
  }).change();

  var bank_id = $('#provider_bank_id').val();

  $('#provider_bank_id').change(function() {
    if (this.value) {
      $('#provider_agency').attr('disabled', false);
      $('#provider_agency').attr('data-modal-url', agencyModalUrl);
    } else {
      $('#provider_agency').attr('disabled', true);
    }

    clearAgency();
  }).change();

  function agencyModalUrl() {
    var url = "<%= modal_agencies_path %>?",
        params = {
          locked_fields: ["bank"],
          agency: {
            bank_id: $('#provider_bank_id').val()
          }
        };

    url += jQuery.param(params);

    return url;
  }

  function clearAgency() {
    if ($('#provider_bank_id').val() != bank_id) {
      bank_id = $('#provider_bank_id').val();

      $('#provider_agency').val('');
      $('#provider_agency_id').val('');
    }
  }

  function togglePartners(personableType) {
    if (personableType == "Individual") {
      $('#msg-no-partners').html("<%= I18n.translate('other.tributario.messages.msg_no_provider_partners') %>").show();
      $('#partners_selector').hide();
    } else {
      $('#msg-no-partners').html('').hide();
      $('#partners_selector').show();
    }
  }

  $('#provider_person_id').change(function(event, data) {
    var type = ''
    if (data) {
      type = data.record.data('personable-type');
    }
    togglePartners(type);
  });

  togglePartners("<%= f.object.personable_type %>");
</script>
