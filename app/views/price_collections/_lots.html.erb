<%= f.error :price_collection_lots %>

<div id="price-collection-lots">
  <%= f.association :price_collection_lots, :collection => localized(f.object.price_collection_lots) do |p| %>
    <%= render 'price_collection_lots/form', :f => p %>
  <% end %>

  <%= mustache 'price-collection-lots-template' do %>
    <%= f.association :price_collection_lots_attributes, :collection => f.object.price_collection_lots.build, :index => '{{uuid_price_collection_lot}}' do |p| %>
      <%= render 'price_collection_lots/form', :f => p %>
    <% end %>
  <% end %>
</div>

<% unless f.object.annulled? %>
  <input type="button" class="button affirmative add-price-collection-lot" value="Adicionar Lote">
<% end %>

<script>
  $("#price-collection-lots-template").nestedForm({
    add: '.add-price-collection-lot',
    remove: '.remove-price-collection-lot',
    target: '#price-collection-lots',
    fieldToRemove: '.price-collection-lot',
    uuid: 'uuid_price_collection_lot',
    appendItem: true
  });

  function setItemLabels(lotDiv) {
    lotDiv.find('.item:visible').each(function(index, _){
      $(this).find('.item-label').html(index + 1);
    });
  }

  function setLotLabels() {
    $('.price-collection-lot:visible').each(function(index, _){
      $(this).find('.lot-label').html(index + 1);
      setItemLabels($(this));
    });
  }

  $('#price-collection-lots').on('append.mustache remove.mustache', setLotLabels);

  setLotLabels();
</script>
