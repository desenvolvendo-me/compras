<%= f.input :purchase_process, modal_url: modal_licitation_processes_path(),
            :disabled => !f.object.purchase_process.nil? %>

<div class="yui3-u-1-3" style="margin-bottom: 20px;">
  <%= f.button :submit, 'data-disabled' => not_updateable_message ,
               :class => 'pledge-request-submit-show-children' %>
</div>

<div id ="div_purchase_solicitation">

<div class="nested-fields add-margin-bottom">
  <%= hidden_field_tag :item_id, nil, :name => 'licitation_process_item[id]' %>

  <div class="yui3-g">
    <div class="yui3-u-1-3">
      <%= f.input :material, :as => :auto_complete, :fake => true, :required => true %>
    </div>
    <div class="yui3-u-1-3">
      <%= f.input :quantity, :as => :fake, :required => true,:input_html => {'data-numeric' => true, :maxlength => 15, :class => 'numeric integer'} %>
    </div>
    <div class="yui3-u-1-3">
      <%= f.input :purchase_solicitation,
                  source_path: purchase_solicitations_path(by_licitation_process: f.object.purchase_process_id),
                  :as => :auto_complete, :fake => true,
                  'data-hidden-field-class' => 'unique', :input_html => {} %>
    </div>
  </div>
  <div class="yui3-u-1-6">
    <%= button_tag 'Adicionar', type: :button,
                   :class => 'button add-nested-record field-without-label',
                   'data-template' => 'licitation_process_items_template',
                   'data-records' => 'items-records',
                   'data-disabled' => not_updateable_message %>
  </div>
</div>

<%= f.error :items %>

<table id="items-records" class="records">
  <thead>
  <tr>
    <th><%= PurchaseProcessItem.human_attribute_name :material %></th>
    <th><%= PurchaseProcessItem.human_attribute_name :quantity %></th>
    <th><%= PurchaseProcessItem.human_attribute_name :purchase_solicitation %></th>
    <th></th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <%= f.association :items, :collection => localized(f.object.items) do |p| %>
    <%= render 'pledge_request_items/form',
               id: p.object.id,
               material: p.object.material,
               material_id: p.object.material_id,
               quantity: number_with_precision(p.object.quantity),
               purchase_solicitation:  p.object.purchase_solicitation,
               purchase_solicitation_id:  p.object.purchase_solicitation_id,
               f: p %>
  <% end %>
  </tbody>
</table>

<%= mustache "licitation_process_items_template" do %>
  <%= f.association :items_attributes, :collection => f.object.items.build, :index => '{{uuid}}' do |p| %>
    <%= render 'pledge_request_items/form',
               id: '{{id}}',
               material: '{{material}}',
               material_id: '{{material_id}}',
               quantity: '{{quantity}}',
               purchase_solicitation: '{{purchase_solicitation}}',
               purchase_solicitation_id: '{{purchase_solicitation_id}}',
               f: p %>
  <% end %>
<% end %>
</div>

<script>
    $(function() {
        // inicio do bloco ,usado para ocultar os filhos do processo de compra
        var input_pledge_request = $('input[name="pledge_request[purchase_process]"]');
        var class_btn_pledge_request = $(".pledge-request-submit-show-children");
        var div_purchase_solicitation = $("#div_purchase_solicitation");
        if (input_pledge_request.val()==""){
            div_purchase_solicitation.hide();
            class_btn_pledge_request.val('Solicitações de Compra');
            class_btn_pledge_request.attr('disabled',true);
            class_btn_pledge_request.attr('title','Escolha um processo de compra!');
            class_btn_pledge_request.attr('class','button pledge-request-submit-show-children');
        }else{
            div_purchase_solicitation.show();
            class_btn_pledge_request.hide();
        }
        input_pledge_request.change(function(){
            if (input_pledge_request.val()=="") {
                $(".pledge-request-submit-show-children").attr('disabled',true);
            }else{
                $(".pledge-request-submit-show-children").attr('disabled',false);
            }
        });
        // fim do bloco
    });
</script>