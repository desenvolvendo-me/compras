<div class="tabs">
  <ul>
    <li><a href="#main">Principal</a></li>
    <li><a href="#moviments">Movimentos</a></li>
  </ul>

  <div id="main">
    <%= render 'general', :f => f %>
  </div>

  <div id="moviments">
    <%= render 'extra_credit_moviment_types', :f => f %>
  </div>
</div>

<script type="text/javascript">
  $('.tabs').tabs({
    create: function () {
      var tabWithError = $('.ui-tabs-panel:has(.error)', this).attr('id');

      if (tabWithError) {
        $(this).tabs('select', tabWithError);
      }
    }
  });

  function calcTotal() {
    var supplement_total = 0.0,
        reduced_total = 0.0,
        supplement_element = $('#extra_credit_supplement'),
        reduced_element =    $('#extra_credit_reduced'),
        difference_element = $('#extra_credit_difference');

    $('#extra-credit-moviment-types').find('fieldset').each(function(){
      var value = parsePtBrFloat($(this).find('.value').val());

      if($(this).find('.destroy').val() == 'false' && !isNaN(value)) {
        var operation = $(this).find('.operation').val();

        if(operation == '<%= MovimentTypeOperation::SUM %>') {
          supplement_total += value;
        } else if(operation == '<%= MovimentTypeOperation::SUBTRATION %>') {
          reduced_total += value;
        }
      }
    });

    supplement_element.val(floatToPtBrString(supplement_total));
    reduced_element.val(floatToPtBrString(reduced_total));
    difference_element.val(floatToPtBrString(supplement_total - reduced_total));
  }

  $('form.extra_credit').delegate('#extra_credit_regulatory_act_id', 'change', function (event, data) {
    if (data) {
      var record = data.record;
      $('#extra_credit_regulatory_act_type').val(record.data('administractive-act-type'));
      $('#extra_credit_publication_date').val(record.data('publication-date'));
    }
  });

  $('form.extra_credit').delegate('#extra_credit_extra_credit_nature_id', 'change', function (event, data) {
    if (data) {
      var record = data.record;
      $('#extra_credit_kind').val(record.data('kind'));
    }
  });

  $('form.extra_credit').delegate('.budget-allocation', 'change', function (event, data) {
    if(data) {
      var record = data.record;

      $(this).closest('fieldset').find('.budget-allocation').attr('data-info-url', "/budget_allocations/"+record.data('id'));
    }
  });

  $('form.extra_credit').delegate('.capability', 'change', function (event, data) {
    if(data) {
      var record = data.record;

      $(this).closest('fieldset').find('.capability').attr('data-info-url', "/capabilities/"+record.data('value'));
    }
  });

  $('form.extra_credit').delegate('.moviment-type', 'change', function (event, data) {
    if (data){
      var record = data.record;
      $(this).closest('fieldset').find('.operation').val(record.data('operation'));

      if(record.data('character') == '<%= MovimentTypeCharacter::BUDGET_ALLOCATION %>') {
        $(this).closest('fieldset').find('.budget-allocation').attr('disabled', false);
        $(this).closest('fieldset').find('.capability').attr('disabled', true);
        $(this).closest('fieldset').find('[id$=capability]').val('');
        $(this).closest('fieldset').find('[id$=capability_id]').val('');
      } else if(record.data('character') == '<%= MovimentTypeCharacter::CAPABILITY %>') {
        $(this).closest('fieldset').find('.capability').attr('disabled', false);
        $(this).closest('fieldset').find('.budget-allocation').attr('disabled', true);
        $(this).closest('fieldset').find('[id$=budget_allocation]').val('');
        $(this).closest('fieldset').find('[id$=budget_allocation_id]').val('');
      }

      calcTotal();
    }
  });

  $('form.extra_credit').delegate('.remove-extra-credit-moviment-type', 'click', function() {
    calcTotal();
  });

  $('form.extra_credit').delegate('.value', 'keyup', function() {
    calcTotal();
  });

  calcTotal();
</script>
