<div class="tabs">
  <ul>
    <li><a href="#general">Principal</a></li>
    <li><a href="#expirations">Vencimentos</a></li>
  </ul>

  <div id="general">
    <%= render 'general', :f => f %>
  </div>

  <div id="expirations">
    <%= render 'expirations', :f => f %>
  </div>
</div>

<script>
  <% if f.object.persisted? %>
    $('form.subpledge :input').attr('disabled', true);
  <% else %>
    function fillExpirationNumber() {
      $('div.subpledge-expiration .destroy[value=false]').each(function(index, item){
        $(this).parent().parent().find('.order').val(index + 1);
      });
    }

    function cleanExistingPledgeParcels() {
      $('#expirations tbody').html('');
    }

    function createPledgeParcelsFromPledge(pledgeExpirations) {
      var template = $('#pledge-expiration-template'),
          rendered = '';

      $(pledgeExpirations).each(function() {
        rendered += template.mustache({
          expiration_date: this.expiration_date,
          value: this.value,
          number: this.number,
          balance: this.balance
        });
      });

      $('#expirations tbody').html(rendered);
    }

    $('#subpledge_pledge_id').change(function (event, pledge) {
      cleanExistingPledgeParcels();

      if (pledge) {
        $('#subpledge_pledge_provider').val(pledge.provider);
        $('#subpledge_emission_date').val(pledge.emission_date);
        $('#subpledge_pledge_value').val(pledge.pledge_value);
        $('#subpledge_value').val(pledge.balance);
        $('#subpledge_provider_id').val(pledge.provider_id);
        $('#subpledge_provider').val(pledge.provider);
        $('#subpledge_description').val(pledge.description);

        $('#pledge_value').html(pledge.pledge_value_as_currency);
        $('#pledge_balance').html(pledge.balance_as_currency);
        createPledgeParcelsFromPledge(pledge.parcels);
      } else {
        $('#subpledge_pledge_provider').val('');
        $('#subpledge_emission_date').val('');
        $('#subpledge_pledge_value').val('');
        $('#pledge_value').html('');
        $('#pledge_balance').html('');
      }
    });

    $('form.subpledge').delegate('.remove-subpledge-expiration', 'click', fillExpirationNumber);
    $('form.subpledge').bind('append.mustache', fillExpirationNumber);

    fillExpirationNumber();
  <% end %>

  function calculateTotalExpirations() {
    var totalExpirations = 0;

    $('.parcel-value:visible').each(function() {
      totalExpirations += parsePtBrFloat($(this).val() || '0');
    });

    $('#subpledge_subpledge_expirations_total_value').val(numberWithDelimiter(totalExpirations))
  }

  $('form.subpledge').delegate('.parcel-value', 'keyup', calculateTotalExpirations)
  $('form.subpledge').delegate('.remove-subpledge-expiration', 'click', calculateTotalExpirations);
</script>
