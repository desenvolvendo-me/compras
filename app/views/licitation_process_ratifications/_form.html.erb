<div class="yui3-g">
  <div class="yui3-u-1-8">
    <%= f.input :sequence, :disabled => true %>
  </div>

  <div class="yui3-u-1-3">
    <%= f.input :licitation_process %>
  </div>

  <div class="yui3-u-1-3">
    <%= f.input :creditor, :disabled => true %>
  </div>
</div>

<div class="yui3-g">
  <div class="yui3-u-1-5">
    <%= f.input :ratification_date %>
  </div>

  <div class="yui3-u-1-5">
    <%= f.input :adjudication_date %>
  </div>
</div>

<table class="records">
  <thead>
    <tr>
      <th><input type="checkbox" id="checkAll"/></th>
      <th><%= Material.human_attribute_name :code %></th>
      <th><%= Material.human_attribute_name :description %></th>
      <th><%= Material.human_attribute_name :reference_unit %></th>
      <th><%= BidderProposal.human_attribute_name :quantity %></th>
      <th><%= BidderProposal.human_attribute_name :unit_price %></th>
      <th><%= BidderProposal.human_attribute_name :total_price %></th>
    </tr>
  </thead>

  <tbody id="ratification_items">
    <%= f.association :licitation_process_ratification_items, :collection => localized(f.object.licitation_process_ratification_items) do |i| %>
      <%= render 'licitation_process_ratification_items/licitation_process_ratification_item', :f => i %>
    <% end %>
  </tbody>
</table>

<%= mustache 'item-template' do %>
  <%= f.association :licitation_process_ratification_items_attributes, :collection => f.object.licitation_process_ratification_items.build, :index => '{{uuid_item}}' do |i| %>
    <%= render 'licitation_process_ratification_items/licitation_process_ratification_item', :f => i %>
  <% end %>
<% end %>


<script>
  $("#item-template").nestedForm({
    target: '#ratification_items',
    append_item: false,
    uuid: 'uuid_item'
  });

  $('#checkAll').change( function() {
    $('table.records input:checkbox').attr('checked', this.checked);
  });

  function clearExistingItems() {
    $('.ratification_item').each(function() {
      $(this).find('input.destroy').attr('value', 'true');
      $(this).hide();
      $(this).find('.description').remove();
    });
  }

  $('#licitation_process_ratification_creditor_id').change(function (event, creditor) {
    clearExistingItems();

    if (creditor) {
      var template = $('#item-template'),
          target = $('#ratification_items'),
          item;

      <% if resource.licitation_process_licitation? %>
        var proposals = creditor.proposals;
      <% else %>
        var proposals = creditor.purchase_items;
      <% end %>

      $.each(proposals, function() {
        item = $('#item-template').mustache({
          uuid_item: _.uniqueId('fresh-'),
          purchase_process_creditor_proposal_id:  this.purchase_process_creditor_proposal_id,
          purchase_process_item_id:               this.purchase_process_item_id,
          code:                                   this.code,
          description:                            this.description,
          quantity:                               this.quantity,
          unit_price:                             this.unit_price,
          reference_unit:                         this.reference_unit,
          total_price:                            this.total_price
        });

        target.prepend(item);
      });
    } else {
      clearExistingItems();
    }
  });

  $(function() {
    var urlModal = "<%= modal_creditors_path %>?",
        licitationProcessId = $('#licitation_process_ratification_licitation_process_id').val(),
        params = {
          <% if resource.licitation_process_licitation? %>
            won_calculation: licitationProcessId,
            without_licitation_ratification: licitationProcessId
          <% else %>
            without_direct_purchase_ratification: licitationProcessId
          <% end %>
        };


    urlModal += jQuery.param(params);

    $("#licitation_process_ratification_creditor").data("modal-url", urlModal).
                                                 attr("disabled", false);

    $('#licitation_process_ratification_licitation_process').attr('disabled', true);
  });
</script>
