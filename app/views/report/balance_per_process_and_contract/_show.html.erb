<%
  def date_mask(d)
    return d.strftime("%d/%m/%Y") unless d.nil?
  end
%>

<div>
  <table class="records">
    <thead>
    <tr style="text-align: center;">
      <td> RELATÃ“RIO DE SALDO POR PROCESSO E CONTRATO</td>
    </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<div style="text-align: justify">

</div>

<br>

<% @licitation_processes.uniq.each do |licitation_process| %>
  <div style="text-align: justify">
  <span>
    <p>
      <b> PROCESSO: </b> <%= licitation_process.to_s %>
    </p>
  </span>
  </div>
  <% total_c_l = 0 %>
  <% total_c_f = 0 %>
  <% licitation_process.contracts.each do |contract| %>
    <div style="text-align: justify">
  <span>
    <p>
      <b> CONTRATO: </b> <%= contract.to_s %>
      <b> FORNECEDOR: </b> <%= contract.creditor.to_s %>
      <b> PRAZO DE VALIDADE: </b> <%= l(contract.end_date, format: :long) %>
    </p>
  </span>
    </div>
    <p>
    <div>
      <table class="records">
        <thead>
        <tr>
          <th>MATERIAL</th>
          <th>QUANTIDADE LICITADA</th>
          <th>QUANTIDADE FORNECIDA</th>
          <th>SALDO</th>
        </tr>
        </thead>
        <tbody>
        <% total_i_l = 0 %>
        <% total_i_f = 0 %>
        <% contract.licitation_process.items.each do |item| %>
          <% balance = SupplyOrder.total_balance(contract.licitation_process, SupplyOrder.where(contract_id: contract.id).first.purchase_solicitation, item.material, item.quantity, SupplyOrder.where(contract_id: contract.id).first, contract) %>
          <% total_i_l += item.quantity %>
          <% total_i_f += balance["total"] %>
          <% total_c_l += item.quantity %>
          <% total_c_f += balance["total"] %>
          <tr>
            <td><%= item.material %></td>
            <td><%= item.quantity %></td>
            <td><%= balance["total"] %></td>
            <td><%= balance["balance"] %></td>
          </tr>
        <% end %>
        </tbody>
        <td colspan="1"></td>
        <td><h2><b>Total Licitado: <%= total_i_l %></b></h2></td>
        <td><h2><b>Total Fornecido: <%= total_i_f %></b></h2></td>
        <td colspan="1"></td>
      </table>
    </div>
    </p>
  <% end %>
  <span>
    <p>
      <b> Total Licitado: </b> <%= total_c_l %>
      <b> Total Fornecido: </b> <%= total_c_f %>
    </p>
  </span>
<% end %>