<div class="yui3-g">
  <div class="yui3-u-1-2">
    <%= f.input :entity %>
  </div>

  <div class="yui3-u-1-2">
    <%= f.input :year %>
  </div>
</div>

<div class="yui3-g">
  <div class="yui3-u-1-3">
    <%= f.input :pledge %>
  </div>

  <div class="yui3-u-1-3">
    <%= f.input :emission_date, :disabled => true, :input_html => { :value => f.object.decorator.emission_date } %>
  </div>

  <div class="yui3-u-1-3">
    <%= f.input :pledge_value, :disabled => true, :input_html => { :value => f.object.decorator.pledge_value } %>
  </div>
</div>

<table id="pledge_parcels" class="records">
  <thead>
    <tr>
      <th>Parcela</th>
      <th>Vencimento</th>
      <th>Valor inicial</th>
      <th>Valor liquidação</th>
      <th>Valor atual</th>
    </tr>
  </thead>
  <tbody>
    <% if f.object.pledge %>
      <% localized(f.object.pledge.pledge_parcels).each do |parcel| %>
        <tr id="parcel_<%= parcel.number %>">
          <td><%= parcel.number %></td>
          <td><%= parcel.expiration_date %></td>
          <td class="value"><%= parcel.decorator.value %></td>
          <td class="liquidations_value"><%= parcel.decorator.liquidations_value %></td>
          <td class="balance"><%= parcel.decorator.balance_as_currency %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<div class="yui3-g">
  <div class="yui3-u-1-2">
    <%= f.input :kind %>
  </div>

  <div class="yui3-u-1-2">
    <%= f.input :value, :disabled => f.object.total? %>
  </div>
</div>

<%= f.input :date %>
<%= f.input :description, :disabled => true %>

<%= mustache 'pledge-parcels-template' do %>
  <tr id="parcel_{{number}}">
    <td>
      {{number}}
    </td>
    <td>
      {{expiration_date}}
    </td>
    <td class="value">
      {{value}}
    </td>
    <td class="liquidations_value">
      {{liquidations_value}}
    </td>
    <td class="balance">
      {{balance}}
    </td>
  </tr>
<% end %>

<script>
  <% if f.object.persisted? %>
    $('form.pledge_liquidation :input').attr('disabled', true);
  <% else %>
    (function() {
      var pledgeId = $('#pledge_liquidation_pledge_id').val(),
          pledgeValue;

      function clearExistingPledgeParcels() {
        $('#pledge_parcels tbody').html('');
      }

      function createPledgeParcelsFromPledge(pledgeParcels) {
        var template = $('#pledge-parcels-template'),
            rendered = '';

        $(pledgeParcels).each(function() {
          rendered += template.mustache({
            expiration_date: this.expiration_date,
            value: this.value,
            number: this.number,
            liquidations_value: this.liquidations_value,
            balance: this.balance
          });
        });

        $('#pledge_parcels tbody').html(rendered);
      }

      function forceValueWhenKindIsTotal(){
        if($('#pledge_liquidation_kind').val() == '<%= PledgeLiquidationKind::TOTAL %>') {
          $('#pledge_liquidation_value').attr('disabled', true);
          $('#pledge_liquidation_value').val(pledgeValue);
        } else {
          $('#pledge_liquidation_value').attr('disabled', false);
        }
      }

      $('#pledge_liquidation_pledge_id').change(function(event, data) {
        if (data) {
          var record = data.record;

          $('#pledge_liquidation_emission_date').val(record.data("emission-date"));
          $('#pledge_liquidation_pledge_value').val(record.data("pledge-value"));
          $('#pledge_liquidation_description').val(record.data("description"));

          createPledgeParcelsFromPledge(record.data('pledge-expirations'));
          pledgeValue = record.data('balance');
        } else {
          $('#pledge_liquidation_emission_date').val('');
          $('#pledge_liquidation_pledge_value').val('');
          $('#pledge_liquidation_expiration_date').val('');
          $('#pledge_liquidation_balance').val('');
          $('#pledge_liquidation_description').val('');

          clearExistingPledgeParcels();
          pledgeValue = null;
        }

        forceValueWhenKindIsTotal();
      });

      $('#pledge_liquidation_kind').change(forceValueWhenKindIsTotal);
    })();
  <% end %>
</script>
