<div class="yui3-g">
  <div class="yui3-u-1-3">
    <%= f.input :budget_allocations, :as => :auto_complete, :hidden_field => :autocomplete_budget_allocation,
                :required => true, :disabled => f.object.annulled?,
                :input_html => { :value => nil, :name => :autocomplete_for_budget_allocation, :class => 'budget-allocation' }  %>
  </div>

  <div class="yui3-u-1-3">
    <%= button_tag 'Adicionar', :class => 'button add-purchase-solicitation-budget-allocation field-without-label' %>
  </div>
</div>

<table class="records">
  <thead>
    <tr>
      <th><%= PurchaseSolicitationBudgetAllocation.human_attribute_name :budget_allocation %></th>
      <th></th>
    </tr>
  </thead>

  <tbody class="<%= f.sanitized_object_name %>_purchase_solicitation_budget_allocations_records">
    <%= f.association :purchase_solicitation_budget_allocations, :collection => localized(f.object.purchase_solicitation_budget_allocations) do |p| %>
      <%= render 'purchase_solicitation_budget_allocations/purchase_solicitation_list_form',
          :budget_allocation => p.object.budget_allocation,
          :budget_allocation_id => p.object.budget_allocation_id,
          :data_disabled => f.object.decorator.is_annulled_message,
          :f => p %>
    <% end %>
  </tbody>
</table>

<%= mustache "purchase_solicitation_budget_allocations_template" do %>
  <%= f.association :purchase_solicitation_budget_allocations, :collection => f.object.purchase_solicitation_budget_allocations.build do |p| %>
    <%= render 'purchase_solicitation_budget_allocations/purchase_solicitation_list_form',
               :budget_allocation => '{{budget_allocation}}',
               :budget_allocation_id => '{{budget_allocation_id}}',
               :data_disabled => nil,
               :f => p %>
  <% end %>
<% end %>

<script>
  $(".add-purchase-solicitation-budget-allocation").on("click", function(event) {
    event.preventDefault();

    var budgetAllocationId = $('#purchase_solicitation_autocomplete_budget_allocation').val(),
        budgetAllocation = $('#purchase_solicitation_budget_allocations').val();

    if (allowAddRecord(budgetAllocationId)) {
      var options = {
          budget_allocation: budgetAllocation,
          budget_allocation_id: budgetAllocationId
        }

      $('.records').append($('#purchase_solicitation_budget_allocations_template').mustache(options));

      clearAutocompleteFields();
    }
  });

  $('form').on('click', '.remove-budget-allocation', function(event) {
    event.preventDefault();
    $(this).closest('.purchase-solicitation-budget-allocation').find('.destroy').val(true);
    $(this).closest('.purchase-solicitation-budget-allocation').hide();
  });

  function clearAutocompleteFields() {
     $('#purchase_solicitation_autocomplete_budget_allocation').val('');
     $('#purchase_solicitation_budget_allocations').val('');
  }

  function allowAddRecord(recordId) {
    var allowed = true;

    if (_.isEmpty(recordId)) {
      alert("<%=I18n.t('purchase_solicitation_budget_allocation.messages.not_allow_add') %>");

      allowed = false
    } else {
      $('.purchase-solicitation-budget-allocation:visible').each(function() {
        var addedRecordId = $(this).find('.budget-allocation-id').val();

        if (recordId == addedRecordId) {
          alert("<%=I18n.t('errors.messages.record_already_exists') %>");

          allowed = false
        }
      })
    }

    return allowed
  }

  $(function() {
    $('.purchase-solicitation-budget-allocation .destroy[value="true"]').closest('.purchase-solicitation-budget-allocation').hide();
  });
</script>
