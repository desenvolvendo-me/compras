<div class="tabs">
  <ul>
    <li>
      <a href="#main">Principal</a>
    </li>

    <li>
      <a href="#items-tab">Itens</a>
    </li>

    <li>
      <a href="#budget-allocations">Dotações orçamentárias</a>
    </li>
  </ul>

  <div id="main">
    <%= render 'main', :f => f %>
  </div>

  <div id="items-tab">
    <%= render 'items', :f => f %>
  </div>

  <div id="budget-allocations">
    <%= render 'budget_allocations', :f => f %>
  </div>
</div>

<script>
  $('form.purchase_solicitation').on('change', '.material', function (event, material) {
    if (material) {
      $(this).closest('.item').find('.reference-unit').val(material.reference_unit);
    }
  });

  function calculateItemsTotalValue() {
    var total = new BigNumber(0),
        value;
    $('.item-price:visible').each(function() {
      value = $(this).attr('value');
      if (value) {
        total = total.add(parsePtBrFloat(value));
      }
    });
    $('#purchase_solicitation_total_items_value').val(numberWithDelimiter(parseFloat(total)));
  }

  $('form.purchase_solicitation').on('keyup', '.item-quantity, .item-unit-price', function() {
    var itemDiv = $(this).closest('.item'),
        itemQuantity = new BigNumber(parsePtBrFloat(itemDiv.find('.item-quantity').val() || '0')),
        itemUnitPrice = new BigNumber(parsePtBrFloat(itemDiv.find('.item-unit-price').val() || '0')),
        total = numberWithDelimiter(parseFloat(itemQuantity.multiply(itemUnitPrice)));

    itemDiv.find('.item-price').val(total);
    calculateItemsTotalValue();
  });

  $('form.purchase_solicitation').on('click', '.remove-purchase-solicitation-budget-allocation, .remove-item', function() {
    calculateItemsTotalValue();
  });

  $('form.purchase_solicitation').on('nestedForm:afterAdd', function(){
    setMaterialLabel();
    setMaterialModalUrl();
    setBudgetAllocationSource();
  });

  $('#purchase_solicitation_budget_structure_id').on("change", function(event, budgetStructure) {
    setBudgetAllocationSource();
  });

  function setBudgetAllocationSource() {
    var url = "<%= budget_allocations_path %>",
    budgetStructureId = $("#purchase_solicitation_budget_structure_id").val(),
    params = {
      budget_structure_id: budgetStructureId
    }

    if (budgetStructureId) {
      url += "?" + jQuery.param(params);
    }

    $(".budget-allocation").data('source', url);
  }

  function setMaterialModalUrl(){
    var url = "<%= modal_materials_path %>?",
    params = {
      locked_fields: ['material_material_type'],
      by_material_type: materialType()
    };

    url += jQuery.param(params);
    $(".material").data('modal-url', url);
  }

  function setMaterialLabel() {
    $(".material").prev("label").html(materialOrService());
    $.each($(".material"), function(index, item) {
      $(item).requiredField(false);
      $(item).requiredField(true);
    });
  }

  function materialOrService() {
    var materialOrService,
        purchaseSolicitationKind = $('#purchase_solicitation_kind').val();

    if (purchaseSolicitationKind === "<%= PurchaseSolicitationKind::SERVICES %>") {
      materialOrService = "Serviço";
    } else {
      materialOrService = "Material";
    }

    return materialOrService;
  }

  function materialType() {
    var material_type,
        purchaseSolicitationKind = $('#purchase_solicitation_kind').val();

    switch (purchaseSolicitationKind) {
      case "<%= PurchaseSolicitationKind::SERVICES %>" :
        material_type = "<%= MaterialType::SERVICE %>";
        break;
      case "<%= PurchaseSolicitationKind::PRODUCTS %>" :
        material_type = "<%= MaterialType::CONSUMPTION %>";
        break;
      case "<%= PurchaseSolicitationKind::GOODS %>" :
        material_type = "<%= MaterialType::ASSET %>";
        break;
    }

    return material_type;
  }
</script>
