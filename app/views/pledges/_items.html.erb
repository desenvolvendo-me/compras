<div class="yui3-g">
  <div class="yui3-u-1-4">
    <%= f.input :parcel_replicated_value, :disabled => true, :input_html => { :class => 'replicated_value' } %>
  </div>

  <div class="yui3-u-1-4">
    <%= f.input :items_total_value, :input_html => { :value => number_to_currency(f.object.items_total_value, :format => "%n") }, :disabled => true %>
  </div>
</div>

<p>
  <input type="button" class="button affirmative add-pledge-item" value="Adicionar Item">
</p>

<div id="pledge-items">
  <%= f.association :pledge_items, :collection => localized(f.object.pledge_items) do |p| %>
    <%= render 'pledge_items/form', :f => p %>
  <% end %>
</div>

<%= mustache 'pledge-items-template' do %>
  <%= f.association :pledge_items_attributes, :collection => f.object.pledge_items.build, :index => '{{uuid_pledge_item}}' do |p| %>
    <%= render 'pledge_items/form', :f => p %>
  <% end %>
<% end %>

<script>
  $("#pledge-items-template").nestedForm({
    add: '.add-pledge-item',
    remove: '.remove-pledge-item',
    target: '#pledge-items',
    uuid: 'uuid_pledge_item',
    fieldToRemove: '.pledge-item',
    appendItem: false
  });

  $('form.pledge').on('change', '.material', function (event, material) {
    if (material) {
      $(this).closest('.pledge-item').find('.item-reference-unit').val(material.reference_unit);
    } else {
      $(this).closest('.pledge-item').find('.item-reference-unit').val('');
    }
  });

  $('form.pledge').on('keyup', '.item-quantity, .item-unit-price', function(){
    var itemDiv = $(this).closest('.pledge-item'),
        itemQuantity = new BigNumber(parsePtBrFloat(itemDiv.find('.item-quantity').val() || '0')),
        itemUnitPrice = new BigNumber(parsePtBrFloat(itemDiv.find('.item-unit-price').val() || '0')),
        total = numberWithDelimiter(parseFloat(itemQuantity.multiply(itemUnitPrice)));

    itemDiv.find('.item-price').attr('value', total);
  });
</script>
