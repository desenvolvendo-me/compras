<div id="supply_order_invoices">

  <div class="nested-fields add-margin-bottom">
    <%= hidden_field_tag :invoice_id, nil, :name => 'invoice[id]' %>

    <div class="yui3-g">
      <div class="yui3-u-1-4">
        <%= f.input :number, :as => :fake, :required => true  %>
      </div>
      <div class="yui3-u-1-4">
        <%= f.input :date, :as => :fake,:input_html => { :class => 'date_pt ' } %>
      </div>
      <div class="yui3-u-1-4">
        <%= f.input :release_date, :as => :fake,:input_html => { :class => 'date_pt ' } %>
      </div>
      <div class="yui3-u-1-4">
        <%= f.input :value, :as => :fake, :input_html =>{ 'data-decimal' => true, :value => '0,00','data-precision' => 2, :maxlength => 15, :class => 'numeric' } %>
      </div>
    </div>

    <div class="yui3-g">
      <div class="yui3-u-1-3">
        <%= f.input :material, :as => :auto_complete, :fake => true,
                    'data-hidden-field-class' => 'unique',
                    :hidden_field => 'invoice_material_id',
                    :source_path => materials_path,
                    :required => true, :disabled => f.object.updatabled %>
      </div>
      <div class="yui3-u-1-3">
        <div class="input fake required supply_order_invoice_quantity">
          <label class="fake required" for="supply_order_invoice_quantity">Quantidade <abbr title="obrigatório">*</abbr></label>
          <input class="string fake required" id="supply_order_invoice_quantity" name="supply_order[invoice_quantity]" type="text" >
        </div>
      </div>
      <div class="yui3-u-1-3">
        <div class="input fake required supply_order_invoice_attended_quantity">
          <label class="fake required" for="supply_order_invoice_attended_quantity">Quantidade Atendida <abbr title="obrigatório">*</abbr></label>
          <input class="string fake required" id="supply_order_invoice_attended_quantity" name="supply_order[invoice_attended_quantity]" type="text" >
        </div>
      </div>
    </div>
    <div class="yui3-g">
      <div class="yui3-u-1-3">
        <div class="input fake required supply_order_invoice_balance">
          <label class="fake required" for="supply_order_invoice_balance">Saldo</label>
          <input class="string fake required" id="supply_order_invoice_balance" name="supply_order[invoice_balance]" type="text" readonly>
        </div>
      </div>
      <div class="yui3-u-1-3">
        <div class="input fake required supply_order_invoice_unitary_value">
          <label class="fake required" for="supply_order_invoice_unitary_value">Valor Unitário <abbr title="obrigatório">*</abbr></label>
          <input class="string fake required" id="supply_order_invoice_unitary_value" name="supply_order[invoice_unitary_value]" type="text" >
        </div>
      </div>
      <div class="yui3-u-1-3">
        <div class="input fake required supply_order_total_value_value">
          <label class="fake required" for="supply_order_total_value_value">Valor Total <abbr title="obrigatório">*</abbr></label>
          <input class="string fake required" id="supply_order_total_value_value" name="supply_order[invoice_unitary_value]" type="text" >
        </div>
      </div>
    </div>


    <div class="yui3-u-1-6">
      <%= button_tag 'Adicionar', type: :button,
                     'data-template' => 'supply_order_invoices_template',
                     'data-records' => 'invoices-records',
                     'data-disabled' => not_updateable_message,
                     :id => "supply_order_invoices_adicionar",
                     :class => 'button add-nested-record field-without-label' %>
    </div>
  </div>

  <%= f.error :invoices %>

  <table id="invoices-records" class="records">
    <thead>
    <tr>
      <th><%= Invoice.human_attribute_name :number %></th>
      <th><%= Invoice.human_attribute_name :date %></th>
      <th><%= Invoice.human_attribute_name :release_date %></th>
      <th><%= Invoice.human_attribute_name :value %></th>
      <th></th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <%= f.association :invoices, :collection => localized(f.object.invoices) do |p| %>
      <%= render 'supply_order_invoices/form',
                 id: p.object.id,
                 number: p.object.number,
                 date: p.object.date,
                 release_date: p.object.release_date,
                 value: p.object.value,
                 f: p %>
    <% end %>
    </tbody>
  </table>

  <%= mustache "supply_order_invoices_template" do %>
    <%= f.association :invoices_attributes, :collection => f.object.invoices.build, :index => '{{uuid}}' do |p| %>
      <%= render 'supply_order_invoices/form',
                 id: '{{id}}',
                 number: '{{number}}',
                 date: '{{date}}',
                 release_date: '{{release_date}}',
                 value: '{{value}}',
                 f: p %>
    <% end %>
  <% end %>
</div>

<script>
  $(function() {
      $('.date_pt').mask('99/99/9999');

      $(".date_pt").blur(function(){
        var regex = /^(((0[1-9]|[12]\d|3[01])\/(0[13578]|1[02])\/((19|[2-9]\d)\d{2}))|((0[1-9]|[12]\d|30)\/(0[13456789]|1[012])\/((19|[2-9]\d)\d{2}))|((0[1-9]|1\d|2[0-8])\/02\/((19|[2-9]\d)\d{2}))|(29\/02\/((1[6-9]|[2-9]\d)(0[48]|[2468][048]|[13579][26])|((16|[2468][048]|[3579][26])00))))$/g;
        if($(this).val() =='' || regex.test($(this).val()) ){
          $("."+ $(this).attr('id') +" p").remove();
        }else{
          $("."+ $(this).attr('id') +" p").remove();
          $("."+ $(this).attr('id')).append('<p class="error date-error">data inválida</p>');
        }
      });

      $("#supply_order_invoices_adicionar").click(function(){
          $(".supply_order_date p").remove();
          $(".supply_order_release_date p").remove();
      });
  });
</script>
