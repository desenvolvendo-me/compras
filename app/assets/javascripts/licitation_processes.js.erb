//= require_tree ./licitation_processes

$(document).ready(function() {
  function organizesModalities() {
    if ($('#licitation_process_type_of_purchase_licitation').is(':checked')){
      $('div.modality').removeClass('hidden');
      $('div.licitation_process_judgment_form_id').removeClass('hidden');
      $('#licitation_process_judgment_form_id').requiredField(true);
      $('#licitation_process_justification_and_legal').requiredField(false);
      $('div.type-of-removal').addClass('hidden');
      $('li.income').removeClass('hidden');
      $('label[for="licitation_process_modality_number"]').html('Nº da modalidade');
      $('label[for="licitation_process_unit_price"]').html('Valor unitário máximo');
      $('a[href="#tab-items"]').html("Itens");
      $('#legal_reasons_tab').addClass('hidden');
      $('.envelope_delivery_date').removeClass('hidden');
      $('#licitation_process_envelope_delivery_date').requiredField(true);
      $('#licitation_process_envelope_delivery_time').requiredField(true);
      $('.proposal_envelope_opening_date').removeClass('hidden');
      $('.closing_of_accreditation_date').removeClass('hidden');
      $('.stage_of_bids_date').removeClass('hidden');
      $('.authorization_envelope_opening_date').removeClass('hidden');
      $('.expiration').removeClass('hidden');
      $('#licitation_process_expiration').requiredField(true);
      $('#licitation_process_expiration_unit').requiredField(true);
    } else {
      $('div.modality').addClass('hidden');
      $('div.licitation_process_judgment_form_id').addClass('hidden');
      $('#licitation_process_judgment_form_id').requiredField(false);
      $('#licitation_process_justification_and_legal').requiredField(true);
      $('div.type-of-removal').removeClass('hidden');
      $('li.income').addClass('hidden');
      $('label[for="licitation_process_modality_number"]').html('Nº do afastamento');
      $('label[for="licitation_process_unit_price"]').html('Valor unitário');
      $('a[href="#tab-items"]').html("Itens / Justificativa");
      $('#licitation_process_modality').val('');
      $('#legal_reasons_tab').removeClass('hidden');
      $('.envelope_delivery_date').addClass('hidden');
      $('#licitation_process_envelope_delivery_date').requiredField(false);
      $('#licitation_process_envelope_delivery_time').requiredField(false);
      $('.proposal_envelope_opening_date').addClass('hidden');
      $('.closing_of_accreditation_date').addClass('hidden');
      $('.stage_of_bids_date').addClass('hidden');
      $('.authorization_envelope_opening_date').addClass('hidden');
      $('.expiration').addClass('hidden');
      $('#licitation_process_expiration').requiredField(false);
      $('#licitation_process_expiration_unit').requiredField(false);
      toogleVisibilityFieldsToTradingAndConcurrence();
    }
  };

  function toogleVisibilityFieldsToTradingAndConcurrence() {
    if (($('#licitation_process_modality').val() == '<%= Modality::TRADING %>' ) || ($('#licitation_process_modality').val() == '<%= Modality::CONCURRENCE %>')) {
      $('.fields-to-trading-and-concurrence').removeClass('hidden');
    } else {
      $('.fields-to-trading-and-concurrence').addClass('hidden');
      $('#licitation_process_price_registration, #licitation_process_eletronic_trading').attr('checked', false)
    }
  };

  function setBudgetAllocationSource() {
    var url = Routes.budget_allocations,
        year   = $("#licitation_process_budget_allocation_year").val(),
        params = { by_year: year };

    if (year){
      url += "?" + jQuery.param(params);
    }

    $("#licitation_process_budget_allocation").data('source', url);
  }

  function toogleVisibilityFieldsToTrading() {
    if (($('#licitation_process_modality').val() == '<%= Modality::TRADING %>')) {
      $('.field-to-trading').removeClass('hidden');
      $('.not-fields-to-trading').addClass('hidden');
    } else {
      $('.field-to-trading').addClass('hidden');
      $('.not-fields-to-trading').removeClass('hidden');
    }
  };

  $('form.licitation_process').on('change', '#licitation_process_budget_allocation_year', function(){
    setBudgetAllocationSource();
  });

  $('input[name="licitation_process[type_of_purchase]"]').change(function(){
    organizesModalities();
    toogleVisibilityFieldsToTrading();
    toogleVisibilityFieldsToTradingAndConcurrence();
  });

  $('#licitation_process_modality').on('change', function() {
    toogleVisibilityFieldsToTrading();
    toogleVisibilityFieldsToTradingAndConcurrence();
  });

  organizesModalities();
  toogleVisibilityFieldsToTrading();
  toogleVisibilityFieldsToTradingAndConcurrence();
  setBudgetAllocationSource();
});
