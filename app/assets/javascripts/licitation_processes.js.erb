//= require_tree ./licitation_processes

$(document).ready(function() {
  function organizesModalities() {
    if ($('#licitation_process_type_of_purchase_licitation').is(':checked')){
      $('div.modality').removeClass('hidden');
      $('div.licitation_process_judgment_form_id').removeClass('hidden');
      $('#licitation_process_judgment_form_id').requiredField(true);
      $('#licitation_process_justification_and_legal').requiredField(false);
      $('div.type-of-removal').addClass('hidden');
      $('li.income').removeClass('hidden');
      $('label[for="licitation_process_modality_number"]').html('Nº da modalidade');
      $('label[for="licitation_process_unit_price"]').html('Valor unitário máximo');
      $('a[href="#tab-items"]').html("Itens");
      $('#legal_reasons_tab').addClass('hidden');
      $('.envelope_delivery_date').removeClass('hidden');
      $('#licitation_process_envelope_delivery_date').requiredField(true);
      $('#licitation_process_envelope_delivery_time').requiredField(true);
      $('.proposal_envelope_opening_date').removeClass('hidden');
      $('.closing_of_accreditation_date').removeClass('hidden');
      $('.stage_of_bids_date').removeClass('hidden');
      $('.authorization_envelope_opening_date').removeClass('hidden');
      $('.expiration').removeClass('hidden');
      $('#licitation_process_expiration').requiredField(true);
      $('#licitation_process_expiration_unit').requiredField(true);
    } else {
      $('div.modality').addClass('hidden');
      $('div.licitation_process_judgment_form_id').addClass('hidden');
      $('#licitation_process_judgment_form_id').requiredField(false);
      $('#licitation_process_justification_and_legal').requiredField(true);
      $('div.type-of-removal').removeClass('hidden');
      $('li.income').addClass('hidden');
      $('label[for="licitation_process_modality_number"]').html('Nº do afastamento');
      $('label[for="licitation_process_unit_price"]').html('Valor unitário');
      $('a[href="#tab-items"]').html("Itens / Justificativa");
      $('#licitation_process_modality').val('');
      $('#legal_reasons_tab').removeClass('hidden');
      $('.envelope_delivery_date').addClass('hidden');
      $('#licitation_process_envelope_delivery_date').requiredField(false);
      $('#licitation_process_envelope_delivery_time').requiredField(false);
      $('.proposal_envelope_opening_date').addClass('hidden');
      $('.closing_of_accreditation_date').addClass('hidden');
      $('.stage_of_bids_date').addClass('hidden');
      $('.authorization_envelope_opening_date').addClass('hidden');
      $('.expiration').addClass('hidden');
      $('#licitation_process_expiration').requiredField(false);
      $('#licitation_process_expiration_unit').requiredField(false);
      toogleVisibilityFieldsToTradingAndConcurrence();
    }
  };

  function toogleVisibilityFieldsToTradingAndConcurrence() {
    if (($('#licitation_process_modality').val() == '<%= Modality::TRADING %>' ) || ($('#licitation_process_modality').val() == '<%= Modality::CONCURRENCE %>')) {
      $('.fields-to-trading-and-concurrence').removeClass('hidden');
    } else {
      $('.fields-to-trading-and-concurrence').addClass('hidden');
      $('#licitation_process_price_registration, #licitation_process_eletronic_trading').attr('checked', false)
    }
  };

  function setBudgetAllocationSource() {
    var url = Routes.budget_allocations,
        year   = $("#licitation_process_budget_allocation_year").val(),
        params = { by_year: year };

    if (year){
      url += "?" + jQuery.param(params);
    }

    $("#licitation_process_budget_allocation").data('source', url);
  }

  function toogleVisibilityFieldsToTrading() {
    if (($('#licitation_process_modality').val() == '<%= Modality::TRADING %>')) {
      $('.field-to-trading').removeClass('hidden');
      $('.not-fields-to-trading').addClass('hidden');
    } else {
      $('.field-to-trading').addClass('hidden');
      $('.not-fields-to-trading').removeClass('hidden');
    }
  };

  $('form.licitation_process').on('change', '#licitation_process_budget_allocation_year', function(){
    setBudgetAllocationSource();
  });

  $('input[name="licitation_process[type_of_purchase]"]').change(function(){
    organizesModalities();
    toogleVisibilityFieldsToTrading();
    toogleVisibilityFieldsToTradingAndConcurrence();
  });

  $('#licitation_process_modality').on('change', function() {
    toogleVisibilityFieldsToTrading();
    toogleVisibilityFieldsToTradingAndConcurrence();
  });

  organizesModalities();
  toogleVisibilityFieldsToTrading();
  toogleVisibilityFieldsToTradingAndConcurrence();
  setBudgetAllocationSource();

//   *************** inicio  ***************

//    adiciona os itens de acordo com a solicitação de compra adicionada
//    (aba solicitante)

    function money_en(value) {
        return parseFloat(value.replace('.','').replace(',','.').
          toLocaleString('en', {minimumFractionDigits: 2}))
    }

    function money_pt(value) {
      return value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    function hasItemAlreadyAdded(item) {
        var added = false;
        $("table#items-records input.material-id").each(function() {
            if ($(this).val() == item.material_id) {
                added = true;
                return added;
            }
        });
        return added;
    }

    function mergeItem(item) {

        var record         = $('tr#material-id-'+item.material_id),
            totalQuantity  = parsePtBrFloat(record.find('input.item-quantity').val())+item.quantity,
            itemUnitPrice  = (money_en(record.find('input.item-unit-price').val())+item.unit_price)/2,
            itemtotalValue = money_pt(numberWithDelimiter(itemUnitPrice*totalQuantity));
            itemUnitPrice = money_pt(itemUnitPrice);

        record.find("td.item-quantity").text(totalQuantity);
        record.find('input.item-quantity').val(totalQuantity);

        record.find("td.item-unit-price").text(itemUnitPrice);
        record.find('input.item-unit-price').val(itemUnitPrice);

        record.find("td.item-total-value").text(itemtotalValue);
        record.find('input.item-total-value').val(itemtotalValue);

    }

    function renderItem(item) {
        var itemBinds = {
            uuid: _.uniqueId('fresh-'),
            id: '',
            material_id: item.material_id,
            material: item.material_description,
            creditor_id: '',
            creditor: '',
            reference_unit: item.reference_unit,
            brand: item.brand,
            quantity: item.quantity,
            lot: '1',
            estimated_total_price:
                money_pt(item.quantity * item.unit_price),
            unit_price: money_pt(item.unit_price)
        };

        var data = $('#licitation_process_items_template').mustache(itemBinds);

        $('#items-records tbody').append(data).trigger("nestedGrid:afterAdd");
    }

  $("#licitation_process_purchase_solicitation_id").on("change", function(event, purchaseSolicitation) {

    if (!purchaseSolicitation) {
      purchaseSolicitation = {};
    }

    $.each(purchaseSolicitation.items, function(i, item) {
      if (hasItemAlreadyAdded(item)) {
        mergeItem(item);
      } else {
        renderItem(item);
      }
    });

  });

//   *************** fim  ***************

});
